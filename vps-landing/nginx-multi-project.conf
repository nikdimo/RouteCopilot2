# Nginx config: WisePlan (domain) + eurbanizam-tracker (IP)
# ==========================================================
# - wiseplan.dk, www.wiseplan.dk → WisePlan (static files)
# - 207.180.222.248 → eurbanizam Admin (Streamlit on port 8501)
#
# REQUIREMENTS:
# - eurbanizam-admin.service must be running: sudo systemctl status eurbanizam-admin
# - Basic auth: eurbanizam uses /etc/nginx/.htpasswd_eurbanizam (create with htpasswd if missing)
#
# APPLY:
#   sudo cp vps-landing/nginx-multi-project.conf /etc/nginx/sites-available/wiseplan
#   sudo nginx -t && sudo systemctl reload nginx
#
# SSL (wiseplan.dk): run certbot after first apply: sudo certbot --nginx -d wiseplan.dk -d www.wiseplan.dk

# --- Block 1: WisePlan (domain) ---
server {
    listen 80;
    listen [::]:80;
    server_name wiseplan.dk www.wiseplan.dk;
    root /var/www/wiseplan-test;
    index index.html;

    location = / {
        try_files /index.html =404;
    }
    location / {
        try_files $uri $uri/ /index.html;
    }

    location /app/ {
        root /var/www/wiseplan-test;
        try_files $uri $uri/ /app/index.html;
    }

    location /_expo/ {
        alias /var/www/wiseplan-test/app/_expo/;
    }

    location = /favicon.ico {
        alias /var/www/wiseplan-test/app/favicon.ico;
    }
}

# --- Block 2: eurbanizam-tracker (IP address) — Streamlit Admin ---
# Proxies to eurbanizam-admin.service (port 8501)
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name 207.180.222.248;

    auth_basic "eurbanizam Admin";
    auth_basic_user_file /etc/nginx/.htpasswd_eurbanizam;

    location / {
        proxy_pass http://127.0.0.1:8501;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}

# --- Block 3: HTTPS for IP — proxy to eurbanizam (fixes Chrome forcing HTTPS) ---
# Serves eurbanizam over HTTPS so Chrome gets correct content. One-time cert acceptance.
# Requires self-signed cert. Run once on VPS:
#   sudo mkdir -p /etc/nginx/ssl
#   sudo openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
#     -keyout /etc/nginx/ssl/ip-selfsigned.key \
#     -out /etc/nginx/ssl/ip-selfsigned.crt \
#     -subj "/CN=207.180.222.248"
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name 207.180.222.248;

    ssl_certificate /etc/nginx/ssl/ip-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/ip-selfsigned.key;

    auth_basic "eurbanizam Admin";
    auth_basic_user_file /etc/nginx/.htpasswd_eurbanizam;

    location / {
        proxy_pass http://127.0.0.1:8501;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
